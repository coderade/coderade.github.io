<!doctype html>
<html class="no-js">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Launching EC2 instances using the Node.js AWS SDK - Coderade blog</title>
        <meta name="author" content="Valdeci Gomes <valdeci@outlook.my>">
        <meta name="description" content="Advanced methods for creating Elastic Cloud Compute instances using the Node.js AWS SDK.">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <meta property="og:locale" content="en_US">
        <meta property="og:url" content="https://coderade.github.io/post/aws/launching-ec2-instances-nodejs-aws-sdk/">
        <meta property="og:title" content="Launching EC2 instances using the Node.js AWS SDK">
        <meta property="og:site_name" content="https://coderade.github.io/">
        <meta property="og:type" content="article" />
        <meta property="og:description" content="Advanced methods for creating Elastic Cloud Compute instances using the Node.js AWS SDK.">
        <meta property="og:image" content="https://coderade.github.io/images/posts/aws/ec2-instances.png">
        <meta property="og:image:type" content="image/jpeg">
        <meta property="og:image:width" content="800">
        <meta property="og:image:height" content="600">

        <meta name="generator" content="Hugo 0.83.1" />
        <link href="https://coderade.github.io/post/index.xml" rel="alternate" type="application/rss+xml" title="Coderade blog" />
        <link href="https://coderade.github.io/post/index.xml" rel="feed" type="application/rss+xml" title="Coderade blog" />
        <link href='//fonts.googleapis.com/css?family=Roboto:400,300,700|Noto+Serif:400,400italic,700,700italic' rel='stylesheet' type='text/css'>
        <link href='  https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://coderade.github.io/css/styles.css">
        <link rel="icon" href="https://coderade.github.io/favicon.ico">
        <link rel="apple-touch-icon" href="https://coderade.github.io/apple-touch-icon.png" />
        <link rel="stylesheet" href="https://coderade.github.io/css/highlightjs/monokai.css">
        <script src="https://coderade.github.io/js/vendor/modernizr-2.8.0.min.js"></script>
        
        <link rel="stylesheet" href="https://coderade.github.io/css/theme.css">
        
        <style>
        .site-header h2 .logo {
        background: url(https://coderade.github.io/img/puralsight-bg.jpg) no-repeat 0 0;
        }
        @media (min--moz-device-pixel-ratio: 1.3), (-o-min-device-pixel-ratio: 2.6 / 2), (-webkit-min-device-pixel-ratio: 1.3), (min-device-pixel-ratio: 1.3), (min-resolution: 1.3dppx) {
          .site-header h2 .logo {
            background-image: url(https://coderade.github.io/img/puralsight-bg.jpg);
        }}
       .site-header {
         background: #2a373d url(https://coderade.github.io/img/puralsight-bg.jpg) no-repeat center center;
         z-index: -1;
        }
        </style>
    </head>
    <body>
        
        <header class="site-header">
          <div class="transparent-layer">
              <h2>&lt;Coding, DevOps and Software Engineering tips/&gt;</h2>
          </div>
        </header>
        <nav class="nav-center" role="navigation">
    <div class="nav-wrapper navbar-info container">
        <ul>
            <li><a href="/">HOME</a></li>
            <li><a href="/about">ABOUT ME</a></li>
            <li><a href="https://github.com/coderade/coderade.io-blog">SOURCE CODE</a></li>
        </ul>
    </div>
</nav>


<div class="container clearfix">
    <main role="main" class="content">
        <article class="post">
            <a class="btn home" href="https://coderade.github.io/" title="Back to home">&laquo; Back to home</a>
            
<h1><a href="https://coderade.github.io/post/aws/launching-ec2-instances-nodejs-aws-sdk/" title="Launching EC2 instances using the Node.js AWS SDK">Launching EC2 instances using the Node.js AWS SDK</a></h1>

<footer class="post-info">Posted on <span class="post-meta"><time datetime="2018.06.24">2018.06.24</time>

    &middot; Tagged in
        
        <a href="https://coderade.github.io/tags/aws">aws</a>, 
        
        <a href="https://coderade.github.io/tags/nodejs">nodejs</a>, 
        
        <a href="https://coderade.github.io/tags/js">js</a>, 
        
        <a href="https://coderade.github.io/tags/ec2">ec2</a>
        
    

</span>



            <p>The EC2 service is one of the most fundamental services offered by AWS.
It underpins many of the other services in AWS, so it’s always a good idea
to understand how to use and the best way to use it.</p>
<p>In this post, I’ll show how to create EC2 instances directly in the code using the
<a href="https://aws.amazon.com/sdk-for-node-js">AWS SDK for JavaScript in Node.js</a>.</p>
<p>To run your application in AWS, we need to have one or more EC2 instances to execute that code.
So, the first step is to create an EC2 instance, there are many different ways to do this.</p>
<p>One of these ways is to use the AWS Console to create instances.
I think that is the easy way because the <a href="https://aws.amazon.com/console/">AWS Console</a>
is very interactive and the AWS documentation is very good and easy to understand.
To check how to create an instance using the AWS console using the official
<a href="https://docs.aws.amazon.com/efs/latest/ug/gs-step-one-create-ec2-resources.html">Step to step documentation</a>.</p>
<p>Another method is to use the <a href="https://aws.amazon.com/cli/">AWS CLI</a>, which is a little more complicated,
but that have good documentation too. This way can be useful with DevOps automation.</p>
<p>For this post, I’ll show how to use the SDK to create an instance with code.</p>
<p>But before we can create an instance, we need to create a few other resources.</p>
<p>In this post, I will show how created the needed resources to use an EC2 instance.</p>
<p>The first thing that we need to do is create a security group for the instance.</p>
<p>So let’s do this.</p>
<h2 id="creating-an-ec2-security-group">Creating an EC2 Security Group</h2>
<p>With a <a href="https://nodejs.org/en/docs/guides/getting-started-guide/">Node.js project</a>
created, the first thing that we need to do is download the AWS SDK module from the
<a href="https://www.npmjs.com/">NPM</a> repository.</p>
<p>To do this, use the following command on the root of your project:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">npm i aws<span style="color:#f92672">-</span>sdk
</code></pre></div><p>Then, we will need to create our script file (this will be where we will the
start file for this example), In this example, I called it as <code>create-ec2-instance.js</code>,
but you can use the name you want.</p>
<p>After that, we need to import the AWS SDK into a local variable in this
file. We will create a const declaration with an identifier of AWS all in caps and
assign the module named <code>'aws-sdk'</code> to it using the require function.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">AWS</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;aws-sdk&#39;</span>);
</code></pre></div><p>The AWS SDK requires you to configure the region each time it&rsquo;s imported. I&rsquo;ll
admit this gets a little annoying. There are some abstractions you can do to
mitigate this, like set the region in the AWS config file on your local system or
export as an environment variable before running.</p>
<p>To understand how to do this use the AWS Docs link of how to
<a href="https://docs.aws.amazon.com/sdk-for-java/v1/developer-guide/setup-credentials.html">Set up AWS Credentials and Region for Development</a></p>
<p>For this example, I will call the update function on the <code>AWS.config</code> property.
Into this function pass an object with one property called <code>region</code>, you also could
add other properties to this object to change other configuration options on the
<code>AWS.config</code> object, such as the max number of retries for a given request or a
global logger object.</p>
<p>Here just enter a string as the value to the <code>region</code> key property with the region
you are using. I&rsquo;ll enter <code>us-east-1</code> here for mine.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">AWS</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">update</span>({<span style="color:#a6e22e">region</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;us-east-1&#39;</span>});
</code></pre></div><p>In my situation, I use more than a region and profile on my computer (for personal
and working coding) so I also need to set my profile using the <code>AWS.config.credentials</code>
property. This configuration will get my AWS credentials data in a shared file used by
SDKs and the command line interface on my computer.
To understand better how to set on this way, use the AWS Docs link of how to
<a href="https://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/loading-node-credentials-shared.html">Loading Credentials in Node.js from the Shared Credentials File</a></p>
<p>In this example, I will load my profile using the
<code>AWS.SharedIniFileCredentials</code> function and load to the <code>AWS.config.credentials</code>
property.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">credentials</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">AWS</span>.<span style="color:#a6e22e">SharedIniFileCredentials</span>({<span style="color:#a6e22e">profile</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;personal&#39;</span>});
<span style="color:#a6e22e">AWS</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">credentials</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">credentials</span>;
</code></pre></div><p>Nice! now we have the Aws settings set! But and now?</p>
<p>Now we need an EC2 object created from the AWS object, on this object we&rsquo;ll call
the EC2 operations on.</p>
<p>So, to use it, declare a new <code>const</code> variable called <code>ec2</code>.
To the right side of an assignment operator, use the new keyword and call the
<a href="https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/EC2.html">AWS.EC2</a> class
with no arguments.</p>
<p>Many other arguments can be passed on the class constructor like
the <code>api-version</code>, <code>accessKeyId</code> and, <code>secretAccessKey</code> and a <code>region</code>. The last
one can be useful if you are using other regions in your code.</p>
<p>To check all the params available to be used on the EC2 constructor, you can<br>
read the docs for the <a href="https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/EC2.html">AWS.EC2</a>
class.</p>
<p>But for this example, an empty EC2 object is all that&rsquo;s needed to create this object.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">ec2</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">AWS</span>.<span style="color:#a6e22e">EC2</span>();
</code></pre></div><p>Now we can start to create the <code>createSecurityGroup</code> function.
Most of the AWS SDK operations have a similar pattern. First, we need to declare
the parameters object to be passed to the SDK function. Then call the function,
passing in a callback to handle the result.</p>
<p>For this function, we need to create a const named <code>params</code> and assign to it an
empty object. We&rsquo;ll use the <code>createSecurityGroup</code> function here and
two of the params arguments that it wants are a description and a group name.</p>
<p>This function will be taking an argument called <code>sgName</code> for the name and the
<code>sgDescription</code> for the description of the Security Group.</p>
<p>I find that the description isn&rsquo;t too useful until you have a massive
number of security groups, even then, it seems that tags are used more for management
in those situations than descriptions.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">createSecurityGroup</span>(<span style="color:#a6e22e">sgName</span>, <span style="color:#a6e22e">sgDescription</span>) {
    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">params</span> <span style="color:#f92672">=</span> {
      <span style="color:#a6e22e">GroupName</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">sgName</span>,
      <span style="color:#a6e22e">Description</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">sgDescription</span>
    };
}
</code></pre></div><p>With the <code>params</code> defined, we can continue to the creation of the function. For these
types of functions, I like to use promises instead of callbacks. IMHO I
think nowadays we must use most of the advantages that ES6 brings to us and
this approach a little easier to understand and read.</p>
<p>In this way, we will return a new Promise. It will take a function with the
resolve and reject callbacks.
Now inside this promise argument function body, we&rsquo;ll call our first SDK function
<a href="https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/EC2.html#createSecurityGroup-property">ec2.createSecurityGroup()</a>.</p>
<p>The first argument will be the params object which we created, then a callback function
with the <code>err</code> and <code>data</code> arguments. Unfortunately, the SDK doesn&rsquo;t support
promises firsthand, so we&rsquo;ll need to use callbacks here.
This function is creating a security group with the name and description
that we pass it. It will not create any security group rules. Inside the function body,
call <code>reject()</code> with the <code>err</code> object if there is one.
In the else, create a block. This is where our code will execute if the security
group creation was successful.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Promise((<span style="color:#a6e22e">resolve</span>, <span style="color:#a6e22e">reject</span>) =&gt; {
    <span style="color:#a6e22e">ec2</span>.<span style="color:#a6e22e">createSecurityGroup</span>(<span style="color:#a6e22e">params</span>, (<span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">data</span>) =&gt; {
        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">err</span>)
            <span style="color:#a6e22e">reject</span>(<span style="color:#a6e22e">err</span>);
        <span style="color:#66d9ef">else</span> {
        }
    })
})
</code></pre></div><p>Because our security group is essentially empty, we want to add a rule here.</p>
<p>We&rsquo;ll want to enable port 22 so that we can SSH into the instance once it&rsquo;s
been created and port 3000 so if want to run an endpoint example like
<a href="https://expressjs.com/">Express</a>
on the instance. So start by creating a new <code>let</code> called <code>params</code> again
and assigning an empty object to it.</p>
<p>There are a few properties required to create this security group rule, which
should sound familiar to you if you&rsquo;ve set one up with the console before.</p>
<p>The first is the <code>GroupId</code> to apply the rule to. We can get that from the data
argument supplied by the creation&rsquo;s callback. For the value here, enter <code>data.GroupId</code>.
The next property is <code>IpPermissions</code>, which is an array. This array enables us
to configure multiple rules in one request.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">params</span> <span style="color:#f92672">=</span> {
    <span style="color:#a6e22e">GroupId</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">GroupId</span>,
    <span style="color:#a6e22e">IpPermissions</span><span style="color:#f92672">:</span> []
};
</code></pre></div><p>Then, we need to create an object in this array and add the property <code>IpProtocol</code>.</p>
<p>The possible values for this are protocols like TCP or UDP, for some examples.
We will use the value <code>'tcp'</code> here, all lowercase. The next two properties <code>FromPort </code>and
<code>ToPort</code> define the port range that you&rsquo;re enabling the rule for.</p>
<p>In the first case, we&rsquo;ll enter the number <code>22</code> in both <code>FromPort</code> and <code>ToPort</code>
since I want to allow SSH on this example.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">params</span> <span style="color:#f92672">=</span> {
    <span style="color:#a6e22e">GroupId</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">GroupId</span>,
    <span style="color:#a6e22e">IpPermissions</span><span style="color:#f92672">:</span> [
        {
            <span style="color:#a6e22e">IpProtocol</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;tcp&#39;</span>,
            <span style="color:#a6e22e">FromPort</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">22</span>,
            <span style="color:#a6e22e">ToPort</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">22</span>,
        }
    ]
}      
</code></pre></div><p>Finally, add the property <code>IpRanges</code>' value as an empty array. Here&rsquo;s where we can define who this rule applies to.</p>
<p>Add an empty object with the property <code>CidrIp</code>. We&rsquo;ll enable access to anyone,
so give this property the value <code>0.0.0.0/0</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">IpRanges</span><span style="color:#f92672">:</span> [
    {
        <span style="color:#a6e22e">CidrIp</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;0.0.0.0/0&#39;</span>
    }
]    
</code></pre></div><p>Now, we need to also add the rule for port 3000, so we can copy the rule object created:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">{
    <span style="color:#a6e22e">IpProtocol</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;tcp&#39;</span>,
    <span style="color:#a6e22e">FromPort</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">22</span>,
    <span style="color:#a6e22e">ToPort</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">22</span>,
    <span style="color:#a6e22e">IpRanges</span><span style="color:#f92672">:</span> [
        {
            <span style="color:#a6e22e">CidrIp</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;0.0.0.0/0&#39;</span>
        }
    ]
}
</code></pre></div><p>add a comma after it and then paste. The only different property will be the
<code>FromPort</code> and <code>ToPort</code> and you can set both to <code>3000</code>.</p>
<p>Awesome! Now we&rsquo;re ready to use this big params object in an SDK call:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">params</span> <span style="color:#f92672">=</span> {
    <span style="color:#a6e22e">GroupId</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">GroupId</span>,
    <span style="color:#a6e22e">IpPermissions</span><span style="color:#f92672">:</span> [
        {
            <span style="color:#a6e22e">IpProtocol</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;tcp&#39;</span>,
            <span style="color:#a6e22e">FromPort</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">22</span>,
            <span style="color:#a6e22e">ToPort</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">22</span>,
            <span style="color:#a6e22e">IpRanges</span><span style="color:#f92672">:</span> [
                {
                    <span style="color:#a6e22e">CidrIp</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;0.0.0.0/0&#39;</span>
                }
            ]
        },
        {
            <span style="color:#a6e22e">IpProtocol</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;tcp&#39;</span>,
            <span style="color:#a6e22e">FromPort</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">3000</span>,
            <span style="color:#a6e22e">ToPort</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">3000</span>,
            <span style="color:#a6e22e">IpRanges</span><span style="color:#f92672">:</span> [
                {
                    <span style="color:#a6e22e">CidrIp</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;0.0.0.0/0&#39;</span>
                }
            ]
        }
    ]
};
</code></pre></div><p>On the EC2 object, we&rsquo;ll be calling the <code>ec2.authorizeSecurityGroupIngress()</code>
function. The ingress part of that function call refers to these rules being
inbound rules. There is also a function called <code>authorizeSecurityGroupEgress()</code>,
which is for outgoing rules but is not needed on this example.</p>
<p>Call the function and pass the params object as the first argument.
The second will again be a callback function with the argument <code>err</code>.</p>
<p>Even though this function does return a second argument, we&rsquo;ll just ignore it.
Inside the callback, call <code>reject()</code> again if there&rsquo;s an <code>err</code> object.</p>
<p>In the else, just call <code>resolve()</code> and with that code complete, we&rsquo;ve successfully
created and assigned rules to a security group.</p>
<p>This is now your <code>createSecurityGroup</code> function:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">createSecurityGroup</span>(<span style="color:#a6e22e">sgName</span>, <span style="color:#a6e22e">sgDescription</span>) {
    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">params</span> <span style="color:#f92672">=</span> {
        <span style="color:#a6e22e">Description</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">sgName</span>,
        <span style="color:#a6e22e">GroupName</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">sgDescription</span>,
    };

    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Promise((<span style="color:#a6e22e">resolve</span>, <span style="color:#a6e22e">reject</span>) =&gt; {
        <span style="color:#a6e22e">ec2</span>.<span style="color:#a6e22e">createSecurityGroup</span>(<span style="color:#a6e22e">params</span>, (<span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">data</span>) =&gt; {
            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">err</span>)
                <span style="color:#a6e22e">reject</span>(<span style="color:#a6e22e">err</span>);
            <span style="color:#66d9ef">else</span> {
                <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">params</span> <span style="color:#f92672">=</span> {
                    <span style="color:#a6e22e">GroupId</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">GroupId</span>,
                    <span style="color:#a6e22e">IpPermissions</span><span style="color:#f92672">:</span> [
                        {
                            <span style="color:#a6e22e">IpProtocol</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;tcp&#39;</span>,
                            <span style="color:#a6e22e">FromPort</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">22</span>,
                            <span style="color:#a6e22e">ToPort</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">22</span>,
                            <span style="color:#a6e22e">IpRanges</span><span style="color:#f92672">:</span> [
                                {
                                    <span style="color:#a6e22e">CidrIp</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;0.0.0.0/0&#39;</span>
                                }
                            ]
                        },
                        {
                            <span style="color:#a6e22e">IpProtocol</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;tcp&#39;</span>,
                            <span style="color:#a6e22e">FromPort</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">3000</span>,
                            <span style="color:#a6e22e">ToPort</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">3000</span>,
                            <span style="color:#a6e22e">IpRanges</span><span style="color:#f92672">:</span> [
                                {
                                    <span style="color:#a6e22e">CidrIp</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;0.0.0.0/0&#39;</span>
                                }
                            ]
                        }
                    ]
                };
                <span style="color:#a6e22e">ec2</span>.<span style="color:#a6e22e">authorizeSecurityGroupIngress</span>(<span style="color:#a6e22e">params</span>, (<span style="color:#a6e22e">err</span>) =&gt; {
                    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">err</span>)
                        <span style="color:#a6e22e">reject</span>(<span style="color:#a6e22e">err</span>);
                    <span style="color:#66d9ef">else</span>
                        <span style="color:#a6e22e">resolve</span>();
                });
            }
        })
    })
}
</code></pre></div><h2 id="creating-a-key-pair">Creating a key pair</h2>
<p>To log in to the instance, we must create a key pair. According to the Amazon
<a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html">docs</a>
the use for the Key pair is:</p>
<blockquote>
<p>Amazon EC2 uses public–key cryptography to encrypt and decrypt login information.
Public–key cryptography uses a public key to encrypt a piece of data, such as a password,
then the recipient uses the private key to decrypt the data.
The public and private keys are known as a key pair.</p>
</blockquote>
<p>In this way, we will need to create a Key Pair to connect to our EC2 instance.</p>
<p>So we need a <code>createKeyPair</code> function, this function will take a <code>keyName</code> argument.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">createKeyPair</span>(<span style="color:#a6e22e">keyName</span>) {}
</code></pre></div><p>This function will be a wrapper for the aws-sdk
<a href="https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/EC2.html#createKeyPair-property">ec2.createKeyPair</a>
function.</p>
<p>This function has the &lsquo;KeyName&rsquo; and the &lsquo;DryRun&rsquo; arguments, but for this example, only
the &lsquo;KeyName&rsquo; argument is needed. The value of this argument will be passed in our
function <code>createKeyPair</code> function.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">params</span> <span style="color:#f92672">=</span> {
  <span style="color:#a6e22e">KeyName</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">keyName</span>, <span style="color:#75715e">/* required */</span>
};
</code></pre></div><p>After declaring the params object, let&rsquo;s return a new Promise with a callback
function with arguments resolve and reject as the argument.</p>
<p>Inside the callback function, we can call the EC2 function createKeyPair,
passing the <code>params</code> object as the first argument. The second argument will be a
callback function with the err and data objects.</p>
<p>If there&rsquo;s an error, then call reject with the err object. In the else, call resolve
with the data object.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Promise((<span style="color:#a6e22e">resolve</span>, <span style="color:#a6e22e">reject</span>) =&gt; {
       <span style="color:#a6e22e">ec2</span>.<span style="color:#a6e22e">createKeyPair</span>(<span style="color:#a6e22e">params</span>, (<span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">data</span>) =&gt; {
           <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">err</span>)
               <span style="color:#a6e22e">reject</span>(<span style="color:#a6e22e">err</span>);
           <span style="color:#66d9ef">else</span>
               <span style="color:#a6e22e">resolve</span>(<span style="color:#a6e22e">data</span>)
       })
   })
</code></pre></div><p>This will be our <code>createKeyPair</code> function:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">createKeyPair</span>(<span style="color:#a6e22e">keyName</span>) {
    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">params</span> <span style="color:#f92672">=</span> {<span style="color:#a6e22e">KeyName</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">keyName</span>};

    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Promise((<span style="color:#a6e22e">resolve</span>, <span style="color:#a6e22e">reject</span>) =&gt; {
        <span style="color:#a6e22e">ec2</span>.<span style="color:#a6e22e">createKeyPair</span>(<span style="color:#a6e22e">params</span>, (<span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">data</span>) =&gt; {
            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">err</span>)
                <span style="color:#a6e22e">reject</span>(<span style="color:#a6e22e">err</span>);
            <span style="color:#66d9ef">else</span>
                <span style="color:#a6e22e">resolve</span>(<span style="color:#a6e22e">data</span>)
        })
    })
}
</code></pre></div><p>This data object is important because when the key pair is created in AWS,
the function returns the contents of that key pair&rsquo;s private key.</p>
<p>If you don&rsquo;t resolve the data argument on the <code>ec2.createKeyPair()</code> function,
it throws away the created key pair and if we don&rsquo;t
save this locally, the key pair is essentially useless.</p>
<p>For this way, I created a KeyPair helper function that will actually take
this key pair data and save it locally as a file, this function I saved on
the helpers' directory with the name <code>keyPairHelper.js</code>. This file will contain
the below code:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">fs</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;fs&#39;</span>);
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">path</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;path&#39;</span>);
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">os</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;os&#39;</span>);

<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">persistKeyPair</span> (<span style="color:#a6e22e">keyData</span>) {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Promise((<span style="color:#a6e22e">resolve</span>, <span style="color:#a6e22e">reject</span>) =&gt; {
        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">keyPath</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">join</span>(<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">homedir</span>(), <span style="color:#e6db74">&#39;.ssh&#39;</span>, <span style="color:#a6e22e">keyData</span>.<span style="color:#a6e22e">KeyName</span>);
        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">options</span> <span style="color:#f92672">=</span> {
            <span style="color:#a6e22e">encoding</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;utf8&#39;</span>,
            <span style="color:#a6e22e">mode</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0o600</span>
        };

        <span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">writeFile</span>(<span style="color:#a6e22e">keyPath</span>, <span style="color:#a6e22e">keyData</span>.<span style="color:#a6e22e">KeyMaterial</span>, <span style="color:#a6e22e">options</span>, (<span style="color:#a6e22e">err</span>) =&gt; {
            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">err</span>) <span style="color:#a6e22e">reject</span>(<span style="color:#a6e22e">err</span>);
            <span style="color:#66d9ef">else</span> {
                <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#39;Key written to&#39;</span>, <span style="color:#a6e22e">keyPath</span>);
                <span style="color:#a6e22e">resolve</span>(<span style="color:#a6e22e">keyData</span>.<span style="color:#a6e22e">KeyName</span>)
            }
        })
    })
}

<span style="color:#a6e22e">module</span>.<span style="color:#a6e22e">exports</span> <span style="color:#f92672">=</span> {
    <span style="color:#a6e22e">persistKeyPair</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">persistKeyPair</span>
};
</code></pre></div><p>This function <code>persistKeyPair()</code> will be called after the <code>createKeyPair()</code> function
which consequently will be called as the return function for our <code>createSecurityGroup()</code>
function at the begin of your <code>create-ec2-instance</code> file.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">createSecurityGroup</span>(<span style="color:#a6e22e">sgName</span>, <span style="color:#a6e22e">sgDescription</span>)
    .<span style="color:#a6e22e">then</span>(() =&gt; {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">createKeyPair</span>(<span style="color:#a6e22e">keyName</span>);
    })
    .<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">keyPairHelper</span>.<span style="color:#a6e22e">persistKeyPair</span>)
</code></pre></div><p>With these methods, our key pair will be created.</p>
<p>Now that we have the methods to create the security group and key pair, we can
finally create an EC2 instance using both.</p>
<h2 id="creating-the-ec2-instance">Creating the EC2 Instance</h2>
<p>The only one unimplemented function in our example is the <code>createInstance()</code>
function.</p>
<p>This function takes in the <code>sgName</code> (security group name) and the <code>keyName</code>
(key pair name) as arguments, the same arguments that were used to create the
other resources.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">createInstance</span>(<span style="color:#a6e22e">sgName</span>, <span style="color:#a6e22e">keyName</span>) {}
</code></pre></div><p>Inside the function, we&rsquo;ll start by defining a <code>params</code> object.</p>
<p>This <code>params</code> object will have many more arguments than the other function ones
we&rsquo;ve made.</p>
<p>The first we&rsquo;ll need to add is <code>ImageId</code>. This is the AMI ID that will be used
to create the instance.</p>
<p>To get an <code>ImageId</code> we need to select an AMI, so let&rsquo;s get one.</p>
<h3 id="selecting-an-amazon-machine-image-ami">Selecting an Amazon Machine Image (AMI)</h3>
<p>There is an EC2 SDK function called
<a href="https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/EC2.html#describeImages-property">describeImages</a>
that can be used to search for AMIs that we can create. The problem is the search
takes a long time and it&rsquo;s just easier to go to the console directly if
you know what you&rsquo;re looking for.</p>
<p>As we only need the ImageId for our AMI, the easiest way is suitable.</p>
<p>So, to select the AMI, we need to go to the <a href="https://console.aws.amazon.com">AWS Console</a>
and then to the <a href="https://console.aws.amazon.com/ec2/v2/home?region=us-east-1">EC2 Dashboard</a>.</p>
<p>Then, we can click on the <em>Launch Instance</em> button and we&rsquo;ll be presented with
the AMI selection screen.</p>
<p><img src="/images/posts/aws/ami-selection-screen.png" alt=""></p>
<p>At the top, there is the Amazon Linux AMI. At the end of that title is the ID.</p>
<p>Yours may or may not be the same as the above image based on when you&rsquo;re reading
this  post and which region you&rsquo;re using.</p>
<p>Either way, for this example, if you don&rsquo;t need a specific one, you can copy
whatever AMI ID is in your AWS Console.</p>
<p>Now we can switch back to your code and paste that in a string as the value to the
<code>ImageId</code> property.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">ImageId</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;ami-14c5486b&#39;</span>, <span style="color:#75715e">//AMI ID that will be used to create the instance
</span></code></pre></div><p>The next property is <code>InstanceType</code>. This is the type of instance such as <code>t2.small</code>
or <code>m4.xlarge</code> and defines the properties of the instance. Like the AMI, if you
don&rsquo;t need a specific one you can use one of the smallest here: <strong>t2.micro</strong>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">InstanceType</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;t2.micro&#39;</span>,
</code></pre></div><p>Then, we need to define the key pair name with the property <code>KeyName</code> and <code>Name</code>,
that we can be entering the value of keyName from the function arguments for both.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">KeyName</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">keyName</span>,
<span style="color:#a6e22e">Name</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">keyName</span>,
</code></pre></div><p>Then, is the <code>MaxCount</code> and <code>MinCount</code> property, which tells AWS how many instances to create.
We can enter 1 for both.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">MaxCount</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>,
<span style="color:#a6e22e">MinCount</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>,
</code></pre></div><p>For more information about the default limits and how to request an increase,
see <a href="https://aws.amazon.com/ec2/faqs/#How_many_instances_can_I_run_in_Amazon_EC2">How many instances can I run in Amazon EC2</a>
in the Amazon EC2 FAQ.</p>
<p>Now we need to add the property <code>SecurityGroups</code> and give it an array as the value.
This is where we add any security groups to the instance.
So, we enter the <code>sgName</code> argument into the array.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">SecurityGroups</span><span style="color:#f92672">:</span> [
            <span style="color:#a6e22e">sgName</span>
        ],
</code></pre></div><p>We can add more than one security group here if you want to.
There&rsquo;s also a <a href="https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/EC2.html#runInstances-property"><code>SecurityGroupIds</code></a>
property that we could use instead and reference the security groups by their IDs
rather than by their names. I find it a little easier to do it by name for this code.</p>
<p>The last property in our params object is <code>UserData</code>.</p>
<p>The <code>UserData</code> has a couple of different uses with EC2 instances, but we will use it to
run shell commands once the instance starts. To understand more of it, please read the
AWS documentation of how to
<a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/user-data.html">run Commands on Your Linux Instance at Launch</a>.</p>
<p>For this example, I will use the following commands on my <code>UserData</code> value:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">commandsString</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">`#!/bin/bash
</span><span style="color:#e6db74">  curl --silent --location https://rpm.nodesource.com/setup_10.x | sudo bash -
</span><span style="color:#e6db74">  sudo yum install -y nodejs
</span><span style="color:#e6db74">  sudo yum install -y git
</span><span style="color:#e6db74">  git clone https://github.com/coderade/aws-ec2-examples
</span><span style="color:#e6db74">  cd repo
</span><span style="color:#e6db74">  npm i
</span><span style="color:#e6db74">  npm run start`</span>;
</code></pre></div><p>Essentially, these commands are just installing Node and Git, cloning the
example project from my <a href="https://github.com/coderade">GitHub</a>, installing the
project dependencies and, then running it.</p>
<p>You can&rsquo;t just put these shell scripts directly into the <code>UserData</code> value, first,
we have to Base64 encode it.</p>
<p>To do this, with Node.js we can create a <a href="https://nodejs.org/api/buffer.html#buffer_buffer">Buffer</a>
of this variable and then convert it to string with the base64 encoding type.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">UserData</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Buffer</span>(<span style="color:#a6e22e">commandsString</span>).<span style="color:#a6e22e">toString</span>(<span style="color:#e6db74">&#39;base64&#39;</span>);
</code></pre></div><p>Now, this will be our final params variable that will send to the EC2
<a href="https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/EC2.html#runInstances-property">runInstances</a>
method:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">params</span> <span style="color:#f92672">=</span> {
    <span style="color:#a6e22e">ImageId</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;ami-14c5486b&#39;</span>, <span style="color:#75715e">//AMI ID that will be used to create the instance
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">InstanceType</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;t2.micro&#39;</span>,
    <span style="color:#a6e22e">KeyName</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">keyName</span>,
    <span style="color:#a6e22e">Name</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">keyName</span>,
    <span style="color:#a6e22e">MaxCount</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>,
    <span style="color:#a6e22e">MinCount</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>,
    <span style="color:#a6e22e">SecurityGroups</span><span style="color:#f92672">:</span> [
        <span style="color:#a6e22e">sgName</span>
    ],
    <span style="color:#a6e22e">UserData</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Buffer</span>(<span style="color:#a6e22e">commandsString</span>).<span style="color:#a6e22e">toString</span>(<span style="color:#e6db74">&#39;base64&#39;</span>)
};
</code></pre></div><p>This is the function that actually does the EC2 instance creation.</p>
<p>Now, we&rsquo;ll return a new Promise with the callback function with resolve and reject
arguments.</p>
<p>Inside that function, we&rsquo;ll call the <code>ec2.runInstances</code>, so we will pass the <code>params</code>
object as the first argument and the second will be a callback function
with <code>err</code> and <code>data</code> arguments.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Promise((<span style="color:#a6e22e">resolve</span>, <span style="color:#a6e22e">reject</span>) =&gt; {
        <span style="color:#a6e22e">ec2</span>.<span style="color:#a6e22e">runInstances</span>(<span style="color:#a6e22e">params</span>, (<span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">data</span>) =&gt; {
            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">err</span>)
                <span style="color:#a6e22e">reject</span>(<span style="color:#a6e22e">err</span>);
            <span style="color:#66d9ef">else</span>
                <span style="color:#a6e22e">resolve</span>(<span style="color:#a6e22e">data</span>)
        })
    })
}
</code></pre></div><p>Then, we will call <code>reject</code> with the <code>err</code> argument if it exists, otherwise, we
will call <code>resolve</code> with the <code>data</code> argument.</p>
<p>We also need to create a method to create our instance tag (that is used as the
name of the instance to help the instances management).</p>
<p>In this way, let&rsquo;s create the <code>createInstanceTag()</code> method which receive the
<code>instanceData</code> that will be the data resolved by the promise of the <code>createInstance()</code>
method and the <code>instanceTagName</code> that will be also passed by that promise
resolution.</p>
<p>On this method, we create an object called <code>params</code> that will contain the
<code>Resources</code> and the <code>Tags</code> properties.</p>
<p>The <code>Resources</code> property will be an array that will contain the IDs of one
or more instances of resources to be tagged. In our example, we will use the ID of
the instance who we just created:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">  <span style="color:#a6e22e">Resources</span><span style="color:#f92672">:</span> [<span style="color:#a6e22e">instanceData</span>.<span style="color:#a6e22e">Instances</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">InstanceId</span>]
</code></pre></div><p>The <code>Tags</code> property will be an array that contains one or more tags. For
this, I will create only one tag with the key <em>Name</em>.</p>
<p>The tags object contains two String properties. The <code>Key</code> property that is the
key of the tag and the <code>Value</code> that as the name says is the value of the tag.</p>
<p>So, to create our <code>Name</code> tag we will set the value <code>'Name'</code> for the <code>Key</code> and the
<code>instanceTagName</code> for the <code>Value</code> property.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">Tags</span><span style="color:#f92672">:</span> [
    {
        <span style="color:#a6e22e">Key</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;Name&#39;</span>,
        <span style="color:#a6e22e">Value</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">instanceTagName</span>
    }
]
</code></pre></div><p>Inside the function, like the other functions, we&rsquo;ll call an EC2 method the
<a href="http://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/EC2.html#createTags-property"><code>ec2.createTags</code></a>.
Then, we will pass the <code>params</code> object as the first argument and the second will
be a callback function with <code>err</code> and <code>data</code> arguments.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Promise((<span style="color:#a6e22e">resolve</span>, <span style="color:#a6e22e">reject</span>) =&gt; {
        <span style="color:#a6e22e">ec2</span>.<span style="color:#a6e22e">createTags</span>(<span style="color:#a6e22e">params</span>, (<span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">data</span>) =&gt; {
            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">err</span>)
                <span style="color:#a6e22e">reject</span>(<span style="color:#a6e22e">err</span>);
            <span style="color:#66d9ef">else</span>
                <span style="color:#a6e22e">resolve</span>(<span style="color:#a6e22e">data</span>)
        })
    })
}
</code></pre></div><p>In this way, this will be our <code>createInstanceTag()</code> method:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">createInstanceTag</span>(<span style="color:#a6e22e">instanceData</span>, <span style="color:#a6e22e">instanceTagName</span>) {
    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">params</span> <span style="color:#f92672">=</span> {
        <span style="color:#a6e22e">Resources</span><span style="color:#f92672">:</span> [<span style="color:#a6e22e">instanceData</span>.<span style="color:#a6e22e">Instances</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">InstanceId</span>],
        <span style="color:#a6e22e">Tags</span><span style="color:#f92672">:</span> [
            {
                <span style="color:#a6e22e">Key</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;Name&#39;</span>,
                <span style="color:#a6e22e">Value</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">instanceTagName</span>
            }
        ]
    };

    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Promise((<span style="color:#a6e22e">resolve</span>, <span style="color:#a6e22e">reject</span>) =&gt; {
        <span style="color:#a6e22e">ec2</span>.<span style="color:#a6e22e">createTags</span>(<span style="color:#a6e22e">params</span>, (<span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">data</span>) =&gt; {
            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">err</span>)
                <span style="color:#a6e22e">reject</span>(<span style="color:#a6e22e">err</span>);
            <span style="color:#66d9ef">else</span>
                <span style="color:#a6e22e">resolve</span>(<span style="color:#a6e22e">data</span>)
        })
    })
}
</code></pre></div><p>The functions are done! wow! And now?</p>
<p>Now we need to call all these functions and create and pass the needed arguments.</p>
<p>First, on the begin of our file (after all the needed aws settings and imports),
we will create some consts variables, the <strong><code>sgName</code></strong>
(the security group name), <strong><code>sgDescription</code></strong> (the security group description),
<strong><code>keyName</code></strong> (the key name for the KeyPair and the <strong><code>instanceTagName</code></strong> (the
name to be used on the Instance tag):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">sgName</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;ec2_examples_security_group&#39;</span>; <span style="color:#75715e">//The security group name
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">sgDescription</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;ec2_examples Security Group description&#39;</span>; <span style="color:#75715e">//the security group description
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">keyName</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;ec2_examples_instance_key&#39;</span>; <span style="color:#75715e">//The key for the KeyPair key
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">instanceTagName</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;EC2 Examples&#39;</span>; <span style="color:#75715e">//The name to be used on the Instance tag
</span></code></pre></div><p>And then, call the created functions passing the need arguments:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">createSecurityGroup</span>(<span style="color:#a6e22e">sgName</span>, <span style="color:#a6e22e">sgDescription</span>)
    .<span style="color:#a6e22e">then</span>(() =&gt; {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">createKeyPair</span>(<span style="color:#a6e22e">keyName</span>);
    })
    .<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">keyPairHelper</span>.<span style="color:#a6e22e">persistKeyPair</span>)
    .<span style="color:#a6e22e">then</span>(() =&gt; {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">createInstance</span>(<span style="color:#a6e22e">sgName</span>, <span style="color:#a6e22e">keyName</span>, <span style="color:#a6e22e">instanceTagName</span>)
    })
    .<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">createInstanceTag</span>)
    .<span style="color:#66d9ef">catch</span>((<span style="color:#a6e22e">err</span>) =&gt; {
        <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">error</span>(<span style="color:#e6db74">&#39;Failed to create instance with:&#39;</span>, <span style="color:#a6e22e">err</span>)
    });
</code></pre></div><p>So, in this way I will call first the <code>createSecurityGroup</code> function to create
the Security Group for our instance, then if everything works properly I will
call the <code>createKeyPair</code> function to create the needed KeyPair to log in the
instance, persisting in our local machine with our Helper function <code>persistKeyPair</code>,
to finish finally calling the <code>createInstance</code> function to create the instance
and then <code>createInstanceTag</code> to create the tag for this instance.</p>
<p>After creating the calling of the functions, the script to create instances with the
NodeJs AWS-SDK is done.</p>
<p>Now, we can run this post example to create our instance.</p>
<h1 id="running-the-script">Running the script</h1>
<p>To run the example, type the command <code>node create-ec2-instance.js</code> at the command line.</p>
<p>After a few seconds, it should print out the location of the key that was written
locally and the details of the instance that were just created.</p>
<p><img src="/images/posts/aws/created-ec2-instance.png" alt=""></p>
<p>And shazam! The EC2 instance has been created only with JavaScript code!</p>
<p>The actual boot-up of the instance can take a few minutes, but you already can
go to the <a href="https://console.aws.amazon.com/ec2">EC2 Console</a> and look in the
region specified at the beginning of this example the instance that was created.</p>
<p><img src="/images/posts/aws/ec2-instances.png" alt=""></p>
<p>We can look at the Security Group and Key Pairs options to see that they are
already created too.</p>
<p>The source of this example is available on my Github project <a href="https://github.com/coderade/aws-ec2-examples/blob/master/create-ec2-instance.js">https://github.com/coderade/aws-ec2-examples/create-ec2-instance.js</a>.</p>
<p>Take a look at it if you need further information.</p>
<p>And that is all!</p>
<p>Thanks for your reading and please take a look at the other blog posts when you have time.</p>
<hr>

            <ul class="share-buttons">
    <li>Share this article:</li>
    <li>
        <a class="icon-facebook-squared" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fcoderade.github.io%2fpost%2faws%2flaunching-ec2-instances-nodejs-aws-sdk%2f" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;" title="Share on Facebook"></a>
    </li>
    <li>
        <a class="icon-twitter" href="https://twitter.com/share?text=Launching%20EC2%20instances%20using%20the%20Node.js%20AWS%20SDK&amp;url=https%3a%2f%2fcoderade.github.io%2fpost%2faws%2flaunching-ec2-instances-nodejs-aws-sdk%2f" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" title="Tweet this article"></a>
    </li>
    <li>
        <a class="icon-gplus" href="https://plus.google.com/share?url=https%3a%2f%2fcoderade.github.io%2fpost%2faws%2flaunching-ec2-instances-nodejs-aws-sdk%2f" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;" title="Share on Google&#43;"></a>
    </li>
    <li>
        <a class="icon-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fcoderade.github.io%2fpost%2faws%2flaunching-ec2-instances-nodejs-aws-sdk%2f&title=Launching%20EC2%20instances%20using%20the%20Node.js%20AWS%20SDK" onclick="window.open(this.href, 'linkedin-share', 'width=600,height=494');return false;" title="Share on Linkedin"></a>
    </li>
</ul>

        </article>
        <div class="comments">
            <h3>Comments</h3>
            <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "coderade" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </div>
    </main>
    <aside class="author">
    <img class="profile-image" src="https://coderade.github.io/img/profile-image.jpg" alt="Valdeci Gomes" />
    <p class="name">by
        <strong>Valdeci Gomes</strong>
    </p>
    <p class="address">Curitiba, PR, Brazil</p>
    <p class="link"></p>
    <ul class="social">
        




<li><a href="//br.linkedin.com/in/valdeci/en" class="icon-linkedin" target="_blank" title="Linkedin"></a></li>









<li><a href="//github.com/coderade" class="icon-github" target="_blank" title="Github"></a></li>



<li><a href="//stackoverflow.com/users/4157589" class="icon-stackoverflow" target="_blank" title="StackOverflow"></a></li>



<li><a href="//stackexchange.com/users/5196485?tab=accounts" class="icon-stackexchange" target="_blank" title="stackExchange"></a></li>



<li><a href="//www.goodreads.com/valdeci" class="fab fa-goodreads" target="_blank" title="goodreads"></a></li>






<li><a href="https://coderade.github.io/post/index.xml" class="icon-rss" target="_blank" title="RSS"></a></li>

    </ul>
    <br><br>
</aside>
    <aside class="author">
   <div class="tags">
      <h2><span>Categories</span></h2>
      <div class="widget-content cloud-label-widget-content">
         
         <span class="label-size label-size-4">
           <a href="/categories/android">Android</a>
         </span>
         
         <span class="label-size label-size-4">
           <a href="/categories/aws">Aws</a>
         </span>
         
         <span class="label-size label-size-4">
           <a href="/categories/coding">Coding</a>
         </span>
         
         <span class="label-size label-size-4">
           <a href="/categories/es6">Es6</a>
         </span>
         
         <span class="label-size label-size-4">
           <a href="/categories/imho">Imho</a>
         </span>
         
         <span class="label-size label-size-4">
           <a href="/categories/nodejs">Nodejs</a>
         </span>
         
         <span class="label-size label-size-4">
           <a href="/categories/rails">Rails</a>
         </span>
         
      </div>
   </div>
</aside>
<aside class="author">
   <div class="tags">
      <h2><span>Tags</span></h2>
      <div class="widget-content cloud-label-widget-content">
         
         <span class="label-size label-size-4">
           <a dir="ltr" href="/tags/android">Android</a>
         </span>
         
         <span class="label-size label-size-4">
           <a dir="ltr" href="/tags/aws">Aws</a>
         </span>
         
         <span class="label-size label-size-4">
           <a dir="ltr" href="/tags/coding">Coding</a>
         </span>
         
         <span class="label-size label-size-4">
           <a dir="ltr" href="/tags/ec2">Ec2</a>
         </span>
         
         <span class="label-size label-size-4">
           <a dir="ltr" href="/tags/es6">Es6</a>
         </span>
         
         <span class="label-size label-size-4">
           <a dir="ltr" href="/tags/idea">Idea</a>
         </span>
         
         <span class="label-size label-size-4">
           <a dir="ltr" href="/tags/imho">Imho</a>
         </span>
         
         <span class="label-size label-size-4">
           <a dir="ltr" href="/tags/js">Js</a>
         </span>
         
         <span class="label-size label-size-4">
           <a dir="ltr" href="/tags/mobile">Mobile</a>
         </span>
         
         <span class="label-size label-size-4">
           <a dir="ltr" href="/tags/nodejs">Nodejs</a>
         </span>
         
         <span class="label-size label-size-4">
           <a dir="ltr" href="/tags/rails">Rails</a>
         </span>
         
         <span class="label-size label-size-4">
           <a dir="ltr" href="/tags/ruby">Ruby</a>
         </span>
         
         <span class="label-size label-size-4">
           <a dir="ltr" href="/tags/web">Web</a>
         </span>
         
      </div>
   </div>
</aside>

</div>

<footer class="main-footer">
  <div class="container clearfix">
        <a class="icon-rss" href="https://coderade.github.io/post/index.xml" title="RSS"></a>
        <p>&copy; 2021 &middot; Powered by <a href="http://gohugo.io">Hugo</a>.</p>
  </div>
</footer>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>window.jQuery || document.write('<script src="https:\/\/coderade.github.io\/js\/vendor\/jquery-1.11.0.min.js"><\/script>')</script>
<script src="https://coderade.github.io/js/plugins.js"></script>




<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-106618202-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
</body>
</html>

